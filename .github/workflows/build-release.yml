name: Build Release

on:
  push:
    branches:
      - main
      - master
      - release/*
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
      - master
  workflow_dispatch:

jobs:
  build-ubuntu-release:
    name: Build Ubuntu 22.04 Release
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Cache dependencies
        uses: actions/cache@v4
        with:
          path: |
            /var/cache/apt/archives
          key: ${{ runner.os }}-22.04-deps-${{ hashFiles('CMakeLists.txt') }}
          restore-keys: |
            ${{ runner.os }}-22.04-deps-

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential \
            cmake \
            git \
            libgmp-dev \
            libboost-system-dev \
            liblua5.2-dev \
            libmariadb-dev \
            libpugixml-dev

      - name: Configure CMake (Release)
        run: |
          mkdir -p build
          cd build
          cmake -DCMAKE_BUILD_TYPE=Release ..

      - name: Build
        run: |
          cd build
          make -j$(nproc)

      - name: Strip binary
        run: |
          strip build/lloegrys

      - name: Get version info
        id: version
        run: |
          echo "commit_sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          if [[ $GITHUB_REF == refs/tags/* ]]; then
            echo "version=${GITHUB_REF#refs/tags/}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          fi

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: lloegrys-ubuntu-22.04-release-${{ steps.version.outputs.version }}
          path: build/lloegrys
          retention-days: 90
          compression-level: 9

      - name: Create release asset (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          mkdir -p release
          cp build/lloegrys release/lloegrys-ubuntu-22.04-release
          cd release
          tar -czf lloegrys-ubuntu-22.04-release.tar.gz lloegrys-ubuntu-22.04-release

      - name: Upload to GitHub Release (on tag)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v1
        with:
          files: release/lloegrys-ubuntu-22.04-release.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
